# Database

## DB migrations

Migrations are generated using [golang-migrate](https://github.com/golang-migrate/migrate) as recommended by the reference guide.

Generating new migration file:
```
migrate create -ext sql -dir ./database/migrations create-your_entity-table
```

Running migrations:
```
migrate -database "postgres://<your-dbuser>:<>@localhost:5432/yourdb?sslmode=disable" -path database/migrations up
```

_Note_ `sslmode=disable` for local dev only

Full reference: https://github.com/golang-migrate/migrate/blob/master/database/postgres/TUTORIAL.md

## Queries
If using `sqlc`, queries need to be manually created in `./queries`, and Go code for querying can be generated by running `make sqlc` command. The command will additionally generate a gomock file for `Querier` interface for unit tests

Files will be created in `/internal/db`. **DO NOT** manually modify the generated files, as they will be overwritten upon re-generation.

## PGX Decimal

The numeric type in PGX DB entities generated using `sqlc` will use https://github.com/ericlagergren/decimal , overridden in `sqlc.yaml`

https://github.com/jackc/pgx/wiki/Numeric-and-decimal-support#:~:text=The%20Go%20language%20does%20not,to%20a%20float64%20or%20string%20.

Eg.

```go
conn, err := pgx.Connect(context.Background(), fmt.Sprintf("postgres://%s:%s@localhost:5432/golang_reference_api?sslmode=disable", os.Getenv("POSTGRES_USER"), os.Getenv("POSTGRES_PASSWORD")))
if err != nil {
	panic(err)
}
defer func() {
	_ = conn.Close(context.Background())
}()

conn.ConnInfo().RegisterDataType(pgtype.DataType{
	Value: &decimal.Big{},
	Name:  "numeric",
	OID:   pgtype.NumericOID
})

q := db.New(conn)
r := repo.NewPGXRepository(q)
```
